'use client'
import { useState, useMemo } from 'react'
import { useData } from '@/components/data-provider'
import { C, MO, I, Btn, Inp, Av, Stt, Modal, DC, SHT, isoToday } from '@/components/ui'

function ShiftForm({employees,pEmp,pDate,onSave}){const ac=employees.filter(e=>e.status==='active');const[ei,setEi]=useState(pEmp||ac[0]?.id||'');const[dt,setDt]=useState(pDate||isoToday());const[tm,setTm]=useState('Day');const emp=employees.find(e=>e.id===ei);const t=SHT.find(x=>x.name===tm);return<div style={{display:'flex',flexDirection:'column',gap:12}}><Inp label="Employee" value={ei} onChange={setEi} options={ac.map(e=>({value:e.id,label:e.name}))}/><Inp label="Date" value={dt} onChange={setDt} type="date"/><Inp label="Shift" value={tm} onChange={setTm} options={SHT.map(x=>x.name)}/>{t&&<div style={{fontSize:11,color:C.txM,fontFamily:MO}}>⏱ {t.time} · {t.h}h</div>}<Btn v="primary" onClick={()=>onSave({employee_id:ei,employee_name:emp?.name,date:dt,template:tm,time_range:t?.time,hours:t?.h,color:t?.color})} disabled={!ei} style={{width:'100%',justifyContent:'center'}}>Create</Btn></div>}

export default function SchedulingPage(){const{emps,shifts,addShift,delShift}=useData();const[wo,setWo]=useState(0);const[modal,setModal]=useState(null);const wk=useMemo(()=>{const d=new Date();d.setDate(d.getDate()-d.getDay()+1+wo*7);return Array.from({length:7},(_,i)=>{const dd=new Date(d);dd.setDate(d.getDate()+i);return dd.toISOString().split('T')[0]})},[wo]);const ac=emps.filter(e=>e.status==='active');const ws=shifts.filter(s=>wk.includes(s.date));return<div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><div><h1 style={{fontSize:20,fontWeight:700}}>Scheduling</h1><p style={{fontSize:12,color:C.txD,marginTop:3}}>{wk[0]}→{wk[6]}</p></div><div style={{display:'flex',gap:6}}><Btn v="ghost" sz="sm" icon="chevL" onClick={()=>setWo(p=>p-1)}/><Btn v="ghost" sz="sm" onClick={()=>setWo(0)}>Today</Btn><Btn v="ghost" sz="sm" icon="chevR" onClick={()=>setWo(p=>p+1)}/><Btn v="primary" sz="sm" icon="plus" onClick={()=>setModal({})}>Add</Btn></div></div><div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:10,marginBottom:18}}><Stt label="This Week" value={ws.length} icon="calendar"/><Stt label="People" value={ac.length} icon="users"/><Stt label="Total" value={shifts.length} icon="clock"/><Stt label="Hours" value={ws.reduce((a,s)=>a+(s.hours||8),0)+'h'} icon="zap"/></div><div style={{border:`1px solid ${C.bd}`,borderRadius:10,overflow:'auto'}}><table style={{width:'100%',borderCollapse:'collapse',minWidth:700}}><thead><tr style={{background:C.bgE}}><th style={{padding:'8px 12px',textAlign:'left',fontSize:10,color:C.txD,textTransform:'uppercase',fontWeight:600,borderBottom:`1px solid ${C.bd}`,minWidth:100}}>Person</th>{wk.map(d=><th key={d} style={{padding:'8px',textAlign:'center',fontSize:10,color:C.txD,textTransform:'uppercase',fontWeight:600,borderBottom:`1px solid ${C.bd}`}}>{new Date(d+'T12:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric'})}</th>)}</tr></thead><tbody>{ac.map(emp=><tr key={emp.id} style={{borderBottom:`1px solid ${C.bdS}`}}><td style={{padding:'6px 12px'}}><div style={{display:'flex',alignItems:'center',gap:6}}><Av name={emp.name} size={22} color={DC[emp.department]}/><span style={{fontSize:11,fontWeight:500}}>{emp.name.split(' ')[0]}</span></div></td>{wk.map(d=>{const s=shifts.find(s=>s.employee_id===emp.id&&s.date===d);return<td key={d} style={{padding:'3px',textAlign:'center'}}>{s?<div onClick={()=>delShift(s.id)} style={{background:`${s.color}12`,border:`1px solid ${s.color}25`,borderRadius:6,padding:'4px',cursor:'pointer'}}><div style={{fontFamily:MO,fontSize:9,fontWeight:700,color:s.color}}>{s.template}</div><div style={{fontSize:9,color:C.txD}}>{s.time_range}</div></div>:<div onClick={()=>setModal({pEmp:emp.id,pDate:d})} style={{height:34,borderRadius:6,border:`1px dashed ${C.bdS}`,cursor:'pointer',display:'grid',placeItems:'center'}} onMouseEnter={e=>e.currentTarget.style.borderColor=C.cy} onMouseLeave={e=>e.currentTarget.style.borderColor=C.bdS}><I n="plus" s={10} c={C.txD}/></div>}</td>})}</tr>)}</tbody></table></div><div style={{display:'flex',gap:14,marginTop:12,fontSize:10,color:C.txD}}>{SHT.map(t=><div key={t.name} style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:7,height:7,borderRadius:2,background:t.color}}/>{t.name}</div>)}</div><Modal open={!!modal} onClose={()=>setModal(null)} title="Create Shift"><ShiftForm employees={emps} pEmp={modal?.pEmp} pDate={modal?.pDate} onSave={async d=>{await addShift(d);setModal(null)}}/></Modal></div>}
