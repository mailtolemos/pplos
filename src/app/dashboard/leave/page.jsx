'use client'
import { useState } from 'react'
import { useData } from '@/components/data-provider'
import { C, MO, Bg, Btn, Inp, Tbl, Tbs, Ety, Modal, LT, isoToday, daysBetween } from '@/components/ui'

function LeaveForm({employees,onSave}){const ac=employees.filter(e=>e.status==='active');const[ei,setEi]=useState(ac[0]?.id||'');const[tp,setTp]=useState('Annual');const[st,setSt]=useState(isoToday());const[en,setEn]=useState(isoToday());const[rs,setRs]=useState('');const emp=employees.find(e=>e.id===ei);return<div style={{display:'flex',flexDirection:'column',gap:12}}><Inp label="Employee" value={ei} onChange={setEi} options={ac.map(e=>({value:e.id,label:e.name}))}/><Inp label="Type" value={tp} onChange={setTp} options={LT}/><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}><Inp label="Start" value={st} onChange={setSt} type="date"/><Inp label="End" value={en} onChange={setEn} type="date"/></div><Inp label="Reason" value={rs} onChange={setRs} textarea placeholder="Optional..."/><div style={{fontSize:12,color:C.txM,fontFamily:MO}}>{daysBetween(st,en)} day(s)</div><Btn v="primary" onClick={()=>onSave({employee_id:ei,employee_name:emp?.name||'?',type:tp,start_date:st,end_date:en,reason:rs,days:daysBetween(st,en)})} disabled={!ei} style={{width:'100%',justifyContent:'center'}}>Submit</Btn></div>}

export default function LeavePage(){const{emps,leaves,addLeave,appLeave,denLeave}=useData();const[tab,setTab]=useState('all');const[modal,setModal]=useState(false);const pn=leaves.filter(l=>l.status==='pending');const dt=tab==='pending'?pn:tab==='approved'?leaves.filter(l=>l.status==='approved'):tab==='denied'?leaves.filter(l=>l.status==='denied'):leaves;return<div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h1 style={{fontSize:20,fontWeight:700}}>Leave</h1><Btn v="primary" icon="plus" onClick={()=>setModal(true)}>New</Btn></div><Tbs tabs={[{id:'all',label:'All',count:leaves.length},{id:'pending',label:'Pending',count:pn.length},{id:'approved',label:'Approved',count:leaves.filter(l=>l.status==='approved').length},{id:'denied',label:'Denied',count:leaves.filter(l=>l.status==='denied').length}]} active={tab} onChange={setTab}/><Tbl cols={[{label:'Employee',render:r=><span style={{fontWeight:500}}>{r.employee_name}</span>},{label:'Type',render:r=><Bg v={r.type==='Sick'?'rose':'default'}>{r.type}</Bg>},{label:'Period',render:r=><span style={{fontFamily:MO,fontSize:11}}>{r.start_date}â†’{r.end_date}</span>},{label:'Days',render:r=><span style={{fontFamily:MO,fontWeight:700}}>{r.days}</span>},{label:'Status',render:r=><Bg v={r.status==='approved'?'green':r.status==='pending'?'amber':'rose'}>{r.status}</Bg>},{label:'',render:r=>r.status==='pending'?<div style={{display:'flex',gap:4}}><Btn v="primary" sz="xs" icon="check" onClick={e=>{e.stopPropagation();appLeave(r.id)}}>OK</Btn><Btn v="ghost" sz="xs" icon="x" onClick={e=>{e.stopPropagation();denLeave(r.id)}}>No</Btn></div>:null}]} data={dt} empty={<Ety icon="calendar" message="No requests" action="New" onAction={()=>setModal(true)}/>}/><Modal open={modal} onClose={()=>setModal(false)} title="Leave Request"><LeaveForm employees={emps} onSave={async d=>{await addLeave(d);setModal(false)}}/></Modal></div>}
